<div class="level-content-wrapper">
  <!-- Arrière-plan -->
  <div class="background-image"></div>

  <!-- Personnage kangourou -->
  <div class="kangaroo-character">
    <img src="assets/img/logo2.gif" alt="Math World Mascotte" />
  </div>

  <!-- Conteneur principal -->
  <div class="level-container">
    <!-- En-tête -->
    <header class="level-header">
      <div class="logo">
        <img src="assets/img/Elearning.png" alt="Logo Math World" />
      </div>
      <div class="header-icons">
        <button class="icon-btn question-btn" aria-label="Aide">?</button>
        <button class="icon-btn close-btn" aria-label="Fermer" (click)="goToCourses()">✕</button>
      </div>
    </header>

    <!-- État de chargement -->
    <div *ngIf="isLoading" class="loading">
      <div class="loading-spinner"></div>
      <p>Chargement du niveau...</p>
    </div>

    <!-- État d'erreur -->
    <div *ngIf="errorMessage" class="error-message">
      <p>{{ errorMessage }}</p>
      <div class="button-group">
        <button (click)="retryLoad()" class="btn btn-primary">Réessayer</button>
        <a [routerLink]="['/course']" class="btn btn-back">Retour aux cours</a>
      </div>
    </div>

    <!-- Contenu du niveau -->
    <div *ngIf="!isLoading && !errorMessage && etape" class="level-content">
      <!-- Titre -->
      <h1 class="level-title">{{ etape.titre }}</h1>
      <p class="level-description">{{ etape.description }}</p>

      <!-- Contenu -->
      <!-- Contenu texte -->
      <div *ngIf="etape.contentType === 'text'" class="content-text">
        <p>{{ etape.contentData }}</p>
      </div>

      <!-- Contenu vidéo -->
      <div *ngIf="etape.contentType === 'video'" class="content-video">
        <div class="video-wrapper">
          <video
            *ngIf="etape.contentData && !etape.contentData.toString().startsWith('http')"
            [src]="etape.contentData"
            controls
            class="video-player"
            aria-label="Vidéo éducative"
          >
            Votre navigateur ne prend pas en charge la lecture de vidéos.
          </video>
          <iframe
            *ngIf="etape.contentData && etape.contentData.toString().startsWith('http')"
            [src]="getSafeUrl(etape.contentData.toString())"
            frameborder="0"
            allowfullscreen
            class="video-frame"
            aria-label="Vidéo intégrée"
          ></iframe>
          <p *ngIf="!etape.contentData" class="error-message">Vidéo non disponible.</p>
        </div>
      </div>

      <!-- Contenu image -->
      <div *ngIf="etape.contentType === 'image'" class="content-image">
        <img [src]="etape.contentData" alt="Image du niveau" />
      </div>

      <!-- Contenu quiz -->
      <div *ngIf="etape.contentType === 'quiz'" class="content-quiz">
        <div *ngIf="!quizSubmitted">
          <div *ngIf="quizQuestions.length > 0; else noQuestions">
            <div *ngFor="let question of quizQuestions; let i = index" class="question-card">
              <h3>Question {{ i + 1 }}: {{ question.text }}</h3>
              <div *ngFor="let option of question.options" class="option">
                <label>
                  <input
                    type="radio"
                    [name]="'question' + i"
                    [value]="option.text"
                    [checked]="quizAnswers[i] === option.text"
                    (change)="onAnswerSelected(i, option.text)"
                    [attr.aria-label]="option.text"
                  />
                  {{ option.text }}
                </label>
              </div>
            </div>
          </div>
          <ng-template #noQuestions>
            <p>Aucune question disponible pour ce quiz.</p>
          </ng-template>
        </div>

        <div *ngIf="quizSubmitted" class="quiz-results">
          <h3>Résultats</h3>
          <p>Score: {{ quizScore }} / {{ quizQuestions.length }}</p>
        </div>
      </div>

      <!-- Boutons -->
      <div class="button-group">
        <button *ngIf="etape.contentType !== 'quiz' || quizSubmitted" (click)="goToNextLevel()" class="btn btn-primary">Suivant</button>
        <button *ngIf="etape.contentType === 'quiz' && !quizSubmitted && quizQuestions.length > 0" [disabled]="quizAnswers.includes(null)" (click)="submitQuiz()" class="btn btn-primary">Valider</button>
        <button (click)="goToCourseMenu()" class="btn btn-back">Retour</button>
      </div>
    </div>
  </div>

  <!-- Personnage oiseau -->
  <div class="bird-character">
    <img src="assets/img/logo2.gif" alt="Math World Mascotte" />
  </div>
</div>