<div class="level-content-wrapper">
  <!-- Fixed background color -->
  <div class="background-solid"></div>

  <!-- Left logo -->
  <div class="main-logo">
    <img src="assets/img/Elearning.png" alt="E-Learning Logo" />
  </div>

  <!-- Main container -->
  <div class="level-container">
    <!-- Header -->
    <header class="level-header">
      <h1 class="level-title">{{ etape?.titre }}</h1>
      <div class="header-actions">
        <button class="icon-btn help-btn" aria-label="Help">?</button>
        <button class="icon-btn close-btn" aria-label="Close" (click)="goToCourses()">âœ•</button>
      </div>
    </header>

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading your lesson...</p>
    </div>

    <!-- Error state -->
    <div *ngIf="errorMessage" class="error-state">
      <p>{{ errorMessage }}</p>
      <div class="button-group">
        <button (click)="retryLoad()" class="btn primary-btn">Try Again</button>
        <button (click)="goToCourses()" class="btn secondary-btn">Back to Courses</button>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!isLoading && !errorMessage && etape" class="content-area">
      <!-- Description -->
      <p *ngIf="etape.description" class="content-description">{{ etape.description }}</p>

      <!-- Text content -->
      <div *ngIf="etape.contentType === 'text'" class="text-content">
        <p>{{ etape.contentData }}</p>
      </div>

      <!-- Video content -->
      <div *ngIf="etape.contentType === 'video'" class="video-content">
        <div class="video-container">
          <video
            *ngIf="etape.contentData && !etape.contentData.toString().startsWith('http')"
            [src]="etape.contentData"
            controls
            class="video-player"
          >
            Your browser doesn't support video playback.
          </video>
          <iframe
            *ngIf="etape.contentData && etape.contentData.toString().startsWith('http')"
            [src]="getSafeUrl(etape.contentData.toString())"
            frameborder="0"
            allowfullscreen
            class="video-frame"
          ></iframe>
        </div>
      </div>

      <!-- Image content -->
      <div *ngIf="etape.contentType === 'image'" class="image-content">
        <img [src]="etape.contentData" alt="Lesson image" />
      </div>

      <!-- Quiz content -->
      <div *ngIf="etape.contentType === 'quiz'" class="quiz-content">
        <div *ngIf="!quizSubmitted">
          <ng-container *ngIf="quizQuestions.length > 0; else noQuestions">
            <div *ngFor="let question of quizQuestions; let i = index" class="question-card">
              <h3>Question {{ i + 1 }}: {{ question.text }}</h3>
              <div class="options-grid">
                <button
                  *ngFor="let option of question.options"
                  class="option-btn"
                  [class.selected]="quizAnswers[i] === option.text"
                  (click)="onAnswerSelected(i, option.text)"
                >
                  {{ option.text }}
                </button>
              </div>
            </div>
          </ng-container>
          <ng-template #noQuestions>
            <p class="no-questions">No questions available for this quiz.</p>
          </ng-template>
        </div>

        <div *ngIf="quizSubmitted && !showCertificate" class="quiz-result">
          <h3>Your Score</h3>
          <div class="score-display">{{ quizScore }} / {{ quizQuestions.length }}</div>
          <p>{{ quizScore >= quizQuestions.length / 2 ? 'Congratulations!' : 'Keep practicing!' }}</p>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="action-buttons">
        <button 
          *ngIf="etape.contentType === 'quiz' && !quizSubmitted && quizQuestions.length > 0" 
          [disabled]="quizAnswers.includes(null)" 
          (click)="submitQuiz()" 
          class="btn primary-btn"
        >
          Submit Answers
        </button>
        
        <button 
          *ngIf="etape.contentType !== 'quiz' || quizSubmitted" 
          (click)="goToNextLevel()" 
          class="btn primary-btn"
        >
          Next Lesson
        </button>
        
        <button (click)="goToCourses()" class="btn secondary-btn">Back to Courses</button>
      </div>
    </div>
  </div>

  <!-- Mascot decoration -->
  <div class="mascot">
    <img src="assets/img/logo2.gif" alt="Learning Mascot" />
  </div>
</div>

<!-- Certificate popup -->
<app-certificate 
  *ngIf="showCertificate" 
  [studentName]="'Student'"
  [courseName]="etape?.titre || 'Course'"
  [score]="quizScore"
  [totalQuestions]="quizQuestions.length"
  [passed]="quizPassed"
  (close)="closeCertificate()"
></app-certificate>